name: coverage

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env: 
  NODE_VERSION: 14

jobs: 
  test:
    runs-on: ubuntu-latest 
    steps:
      - name: Install NodeJS
        uses: actions/setup-node@v2
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Code Checkout
        uses: actions/checkout@v2
        
      - name: Install Dependencies
        run: npm install

      - name: Get Coverage
        run: |
          # var SUMMARY = [
          #   '',
          #   '=============================== Coverage summary ===============================',
          #   'Statements   : 32.5% ( 39/120 )',
          #   'Branches     : 38.89% ( 21/54 )',
          #   'Functions    : 21.74% ( 5/23 )',
          #   'Lines        : 31.93% ( 38/119 )',
          #   '================================================================================',
          #   ''
          # ];
          # SUMMARY = SUMMARY.split('\n')[5]; // 'Lines        : 31.93% ( 38/119 )'
          # SUMMARY = SUMMARY.split(':')[1].split('%')[0].trim(); // '31.93'
          SUMMARY="$(npm run-script test:vitest-coverage-ci | tail -2 | head -1)"
          TOKENS=($SUMMARY)
          # process.env.COVERAGE = '31.93%';
          echo "COVERAGE=$(echo ${TOKENS[2]})" >> $GITHUB_ENV

      - name: Create Badge
        uses: schneegans/dynamic-badges-action@v1.6.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: 3eca25da4f1f1f04172a54cfd111b698
          filename: astro-template-coverage.json
          label: coverage
          message: ${{ env.COVERAGE }}
          minColorRange: 0
          maxColorRange: 100
          valColorRange: ${{ env.COVERAGE }}.split('%')[0]
          namedLogo: vitest
